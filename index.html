<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Producción</title>
    <link href="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css)" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="[https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css](https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css)">
    <style>
        body {
            background-color: #f8f9fa;
        }
        #app-container {
            display: none;
        }
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        /* --- Kanban Styles --- */
        #kanban-board {
            display: flex; /* Changed to flex for grouping */
            gap: 2rem; /* Space between main groups */
            overflow-x: auto;
            padding-bottom: 1rem;
            align-items: flex-start; /* Align groups at the top */
        }
        .kanban-group {
            background-color: #f1f3f5; /* Slightly different background for group */
            padding: 1rem;
            border-radius: 0.5rem;
            flex-shrink: 0; /* Prevent groups from shrinking */
        }
        .kanban-group h4 {
            text-align: center;
            margin-bottom: 1rem;
            color: #495057;
        }
        .kanban-columns-container {
            display: flex;
            gap: 1rem; /* Space between columns inside a group */
        }
        .kanban-column {
            min-width: 280px; /* Slightly narrower columns */
            max-width: 320px;
            background-color: #e9ecef;
            border-radius: 0.5rem;
            padding: 0.5rem;
            flex-shrink: 0;
            height: fit-content; /* Adjust height based on content */
        }
        .kanban-column h5 {
            text-align: center;
            padding: 0.5rem;
            background-color: #dee2e6;
            border-radius: 0.3rem;
            margin-bottom: 1rem;
            font-size: 0.9rem; /* Smaller column titles */
            word-break: break-word;
        }
        .kanban-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.3rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: grab;
        }
        .kanban-card:active {
             cursor: grabbing; /* Feedback while dragging */
        }
        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .kanban-card-header h6 { /* Cliente / Numero Pedido */
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 0; /* Remove default margin */
            word-break: break-all; /* Prevent long names overflow */
        }
        .kanban-card-body p { /* Detalles */
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            color: #6c757d;
        }
        .kanban-card-footer {
            margin-top: 0.75rem;
            text-align: center;
        }
        .kanban-card-footer .btn {
            width: 100%; /* Make button full width */
        }
        .etapas-display { /* Display for sequence */
            font-size: 0.75rem;
            color: #495057;
            margin-top: 5px;
            word-break: break-word; /* Wrap long sequences */
        }
        .drag-over {
            border: 2px dashed #0d6efd; /* Visual feedback for drop zone */
            background-color: #cfe2ff;
        }
        /* --- List View Styles --- */
        #list-view .table th, #list-view .table td {
            font-size: 0.9rem; /* Adjust font size for better readability */
            vertical-align: middle;
        }
        #list-view .table th {
            background-color: #e9ecef;
        }
        /* --- Modal Styles (no changes) --- */
        .modal-body .row > div {
             margin-bottom: 0.8rem;
        }
        #etapas-secuencia-container label {
            margin-right: 10px;
        }
    </style>
</head>
<body>

    <div id="login-container" class="login-container">
        <h2 class="text-center mb-4">Iniciar Sesión</h2>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Correo Electrónico</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Ingresar</button>
            </div>
            <div id="login-error" class="text-danger mt-3 text-center" style="display: none;"></div>
        </form>
    </div>

    <div id="app-container" class="container-fluid mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Control Producción</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span id="user-email" class="navbar-text me-3"></span>
                        </li>
                        <li class="nav-item">
                            <button id="logout-button" class="btn btn-outline-danger">Cerrar Sesión</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div id="main-content">
            <h1 class="text-center">Por favor, inicia sesión</h1>
        </div>
    </div>

    <div class="modal fade" id="pedidoModal" tabindex="-1" aria-labelledby="pedidoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pedidoModalLabel">Añadir Nuevo Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="pedido-form">
                        <input type="hidden" id="pedido-id">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="numeroPedido" class="form-label">Número Pedido (Cliente - Número)*</label>
                                <input type="text" class="form-control" id="numeroPedido" required>
                            </div>
                            <div class="col-md-6">
                                <label for="cliente" class="form-label">Cliente (Opcional)</label>
                                <input type="text" class="form-control" id="cliente">
                            </div>
                        </div>
                        <hr>
                        <h6>Características Principales</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="maquinaImpresion" class="form-label">Máquina Impresión*</label>
                                <select class="form-select" id="maquinaImpresion" required>
                                    <option value="" selected disabled>Seleccionar...</option>
                                    <option value="WindMöller 1">WindMöller 1</option>
                                    <option value="GIAVE">GIAVE</option>
                                    <option value="WindMöller 3">WindMöller 3</option>
                                    <option value="Anonimo">Anonimo</option>
                                </select>
                            </div>
                             <div class="col-md-4">
                                <label for="desarrTexto" class="form-label">Desarr. (Texto)</label>
                                <input type="text" class="form-control" id="desarrTexto">
                            </div>
                            <div class="col-md-4">
                                <label for="desarrNumero" class="form-label">Desarr. (Número)</label>
                                <input type="number" class="form-control" id="desarrNumero">
                            </div>
                            <div class="col-md-4">
                                <label for="metros" class="form-label">Metros</label>
                                <input type="number" class="form-control" id="metros">
                            </div>
                            <div class="col-md-4">
                                <label for="superficie" class="form-label">Superficie (SUP)</label>
                                <select class="form-select" id="superficie">
                                    <option value="false">No</option>
                                    <option value="true">Sí</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="transparencia" class="form-label">Transparencia (TTE)</label>
                                <select class="form-select" id="transparencia">
                                    <option value="false">No</option>
                                    <option value="true">Sí</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="capa" class="form-label">Capa (CAPA)</label>
                                <input type="text" class="form-control" id="capa">
                            </div>
                            <div class="col-md-4">
                                <label for="camisa" class="form-label">Camisa</label>
                                <input type="text" class="form-control" id="camisa">
                            </div>
                             <div class="col-md-4">
                                <label for="fecha" class="form-label">Fecha (FH)</label>
                                <input type="text" class="form-control" id="fecha" placeholder="DD/MM">
                            </div>
                        </div>
                         <div class="row">
                             <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" rows="2"></textarea>
                            </div>
                        </div>
                        <hr>
                        <h6>Secuencia de Etapas (Seleccionar en orden)</h6>
                        <p class="form-text text-muted">La etapa de impresión seleccionada arriba se añadirá automáticamente al inicio.</p>
                        <div id="etapas-secuencia-container" class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Laminación SL2" id="etapa-sl2">
                                <label class="form-check-label" for="etapa-sl2">Laminación SL2</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Laminación NEXUS" id="etapa-nexus">
                                <label class="form-check-label" for="etapa-nexus">Laminación NEXUS</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Perforación MAC" id="etapa-mac">
                                <label class="form-check-label" for="etapa-mac">Perforación MAC</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Perforación MIC" id="etapa-mic">
                                <label class="form-check-label" for="etapa-mic">Perforación MIC</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Rebobinado S2DT" id="etapa-s2dt">
                                <label class="form-check-label" for="etapa-s2dt">Rebobinado S2DT</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Rebobinado PROSLIT" id="etapa-proslit">
                                <label class="form-check-label" for="etapa-proslit">Rebobinado PROSLIT</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Rebobinado TEMAC" id="etapa-temac">
                                <label class="form-check-label" for="etapa-temac">Rebobinado TEMAC</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Pendiente de Laminar" id="etapa-pdlam">
                                <label class="form-check-label" for="etapa-pdlam">P.D. Laminar</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Pendiente de Rebobinado" id="etapa-pdreb">
                                <label class="form-check-label" for="etapa-pdreb">P.D. Rebobinado</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" form="pedido-form">Guardar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <script src="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js](https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js)" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "[https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js](https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js)";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "[https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js](https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js)";
        import {
            getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, doc, updateDoc
        } from "[https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js](https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js)";

        // Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyBp5a0lUJYZWhtUTVDuwn1jvj6TodaCyrc",
          authDomain: "production-control-pigmea.firebaseapp.com",
          projectId: "production-control-pigmea",
          storageBucket: "production-control-pigmea.firebasestorage.app",
          messagingSenderId: "1008458265879",
          appId: "1:1008458265879:web:008889d56b1d4de3cc3352"
        };

        // Firebase Init
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const pedidosCollection = collection(db, "pedidos");

        console.log("Firebase inicializado.");

        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userEmailSpan = document.getElementById('user-email');
        const mainContent = document.getElementById('main-content');
        const pedidoModalElement = document.getElementById('pedidoModal');
        const pedidoModal = new bootstrap.Modal(pedidoModalElement);
        const pedidoForm = document.getElementById('pedido-form');
        const pedidoModalLabel = document.getElementById('pedidoModalLabel');
        const pedidoIdInput = document.getElementById('pedido-id');

        // --- Auth Listeners ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission
            console.log("Login form submit event intercepted."); // Verify preventDefault is called

            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.style.display = 'none';

            try {
                console.log(`Intentando iniciar sesión con ${email}`);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Inicio de sesión exitoso:", userCredential.user);
                // onAuthStateChanged handles UI changes
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                loginError.textContent = getFirebaseErrorMessage(error);
                loginError.style.display = 'block';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Cierre de sesión exitoso.");
                // onAuthStateChanged handles UI changes
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                alert("Error al cerrar sesión. Inténtalo de nuevo.");
            }
        });

        // --- Auth State Observer ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuario conectado:", user.email);
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userEmailSpan.textContent = user.email;
                loadMainAppData();
            } else {
                console.log("Usuario desconectado.");
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                userEmailSpan.textContent = '';
                mainContent.innerHTML = '<h1 class="text-center">Por favor, inicia sesión</h1>';
                if (unsubscribePedidos) {
                    console.log("Deteniendo listener de pedidos.");
                    unsubscribePedidos();
                    unsubscribePedidos = null;
                }
            }
        });

        function getFirebaseErrorMessage(error) {
             switch (error.code) {
                case 'auth/invalid-email': return 'El formato del correo electrónico no es válido.';
                case 'auth/user-disabled': return 'Este usuario ha sido deshabilitado.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Correo electrónico o contraseña incorrectos.';
                case 'auth/too-many-requests': return 'Demasiados intentos fallidos. Inténtalo más tarde.';
                default: return 'Error al iniciar sesión. Por favor, inténtalo de nuevo.';
            }
        }

        // --- Main App Logic ---
        let currentPedidos = [];
        let unsubscribePedidos = null;
        let draggedItemId = null;

        function loadMainAppData() {
            console.log("Cargando datos principales de la aplicación...");
             if (!document.getElementById('view-kanban-btn')) {
                mainContent.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button id="view-kanban-btn" class="btn btn-primary me-2 active">Vista Kanban</button>
                            <button id="view-list-btn" class="btn btn-secondary">Vista Lista</button>
                            <button id="export-btn" class="btn btn-outline-success ms-2" disabled title="Funcionalidad no implementada">Exportar Lista</button>
                        </div>
                        <div>
                            <input type="text" id="search-input" class="form-control d-inline-block w-auto me-2" placeholder="Buscar pedido...">
                            <button id="add-pedido-btn" class="btn btn-success">+ Añadir Pedido</button>
                        </div>
                    </div>
                    <div id="kanban-board" class="mt-4"></div>
                    <div id="list-view" class="mt-4" style="display: none;"></div>
                `;

                // Setup listeners only once
                const viewKanbanBtn = document.getElementById('view-kanban-btn');
                const viewListBtn = document.getElementById('view-list-btn');
                const kanbanBoard = document.getElementById('kanban-board');
                const listView = document.getElementById('list-view');
                const exportBtn = document.getElementById('export-btn');

                viewKanbanBtn.addEventListener('click', () => {
                    kanbanBoard.style.display = 'flex';
                    listView.style.display = 'none';
                    viewKanbanBtn.classList.add('active');
                    viewListBtn.classList.remove('active');
                    exportBtn.disabled = true;
                    renderKanban(currentPedidos);
                });
                viewListBtn.addEventListener('click', () => {
                    kanbanBoard.style.display = 'none';
                    listView.style.display = 'block';
                    viewKanbanBtn.classList.remove('active');
                    viewListBtn.classList.add('active');
                    exportBtn.disabled = false;
                    renderList(currentPedidos);
                });

                document.getElementById('add-pedido-btn').addEventListener('click', () => openPedidoModal());

                if (!pedidoForm.dataset.listenerAttached) {
                     pedidoForm.addEventListener('submit', savePedido);
                     pedidoForm.dataset.listenerAttached = 'true';
                }

                document.getElementById('search-input').addEventListener('input', handleSearch);

                 exportBtn.addEventListener('click', () => {
                     alert('La funcionalidad de exportar a PDF/Excel aún no está implementada.');
                 });
            }

            if (!unsubscribePedidos) {
                 listenToPedidos();
            } else {
                 renderActiveView(currentPedidos);
            }
        }

        function handleSearch(e) {
             const searchTerm = e.target.value.toLowerCase();
             const filteredPedidos = currentPedidos.filter(pedido =>
                 (pedido.numeroPedido && pedido.numeroPedido.toLowerCase().includes(searchTerm)) ||
                 (pedido.cliente && pedido.cliente.toLowerCase().includes(searchTerm)) ||
                 (pedido.maquinaImpresion && pedido.maquinaImpresion.toLowerCase().includes(searchTerm)) ||
                 (pedido.etapaActual && pedido.etapaActual.toLowerCase().includes(searchTerm))
             );
             renderActiveView(filteredPedidos);
        }

        function renderActiveView(pedidosToRender) {
            const kanbanBoard = document.getElementById('kanban-board');
            if (kanbanBoard && kanbanBoard.style.display !== 'none') {
                renderKanban(pedidosToRender);
            } else if (document.getElementById('list-view')) {
                renderList(pedidosToRender);
            }
        }

        function listenToPedidos() {
            console.log("Escuchando cambios en la colección 'pedidos'...");
            if (unsubscribePedidos) unsubscribePedidos();

            const q = query(pedidosCollection);

            unsubscribePedidos = onSnapshot(q, (querySnapshot) => {
                currentPedidos = [];
                querySnapshot.forEach((doc) => {
                    currentPedidos.push({ id: doc.id, ...doc.data() });
                });
                console.log("Pedidos actualizados:", currentPedidos.length);
                const searchTerm = document.getElementById('search-input')?.value || '';
                handleSearch({ target: { value: searchTerm } });

            }, (error) => {
                console.error("Error al escuchar pedidos:", error);
                if (error.code === 'permission-denied') {
                     alert("Error al cargar los datos: Permisos insuficientes. Revisa las reglas de Firestore.");
                }
                if (unsubscribePedidos) unsubscribePedidos();
                unsubscribePedidos = null;
            });
        }

        // --- Kanban Rendering and Drag & Drop ---
        function renderKanban(pedidos) {
            const kanbanBoard = document.getElementById('kanban-board');
            if (!kanbanBoard) return;
            kanbanBoard.innerHTML = '';

            const etapasImpresion = ["Impresión WindMöller 1", "Impresión GIAVE", "Impresión WindMöller 3", "Impresión Anonimo"];
            const etapasComplementarias = [
                "Laminación SL2", "Laminación NEXUS", "Perforación MAC", "Perforación MIC",
                "Rebobinado S2DT", "Rebobinado PROSLIT", "Rebobinado TEMAC",
                "Pendiente de Laminar", "Pendiente de Rebobinado", "Completado"
            ];

            const groupImpresionDiv = createKanbanGroup("Etapa Impresión", etapasImpresion, pedidos);
            const groupComplementariaDiv = createKanbanGroup("Etapa Complementaria", etapasComplementarias, pedidos);

            kanbanBoard.appendChild(groupImpresionDiv);
            kanbanBoard.appendChild(groupComplementariaDiv);

            addDragAndDropListeners();
        }

        function createKanbanGroup(groupTitle, etapasInGroup, allPedidos) {
            const groupDiv = document.createElement('div');
            groupDiv.classList.add('kanban-group');
            const titleH4 = document.createElement('h4');
            titleH4.textContent = groupTitle;
            groupDiv.appendChild(titleH4);
            const columnsContainer = document.createElement('div');
            columnsContainer.classList.add('kanban-columns-container');
            etapasInGroup.forEach(etapa => {
                const columnDiv = document.createElement('div');
                columnDiv.classList.add('kanban-column');
                columnDiv.dataset.etapa = etapa;
                const title = document.createElement('h5');
                title.textContent = etapa;
                columnDiv.appendChild(title);
                const pedidosEnEtapa = allPedidos.filter(p => p.etapaActual === etapa);
                pedidosEnEtapa.forEach(pedido => {
                    columnDiv.appendChild(createKanbanCard(pedido));
                });
                columnsContainer.appendChild(columnDiv);
            });
            groupDiv.appendChild(columnsContainer);
            return groupDiv;
        }

        function createKanbanCard(pedido) {
            const cardDiv = document.createElement('div');
            cardDiv.classList.add('kanban-card');
            cardDiv.draggable = true;
            cardDiv.dataset.id = pedido.id;

            const cardHeader = document.createElement('div');
            cardHeader.classList.add('kanban-card-header');
            const cardTitle = document.createElement('h6');
            cardTitle.textContent = pedido.cliente ? `${pedido.cliente} - ${pedido.numeroPedido}` : pedido.numeroPedido;
            cardHeader.appendChild(cardTitle);
            const editButton = document.createElement('button');
            editButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary');
            editButton.innerHTML = '<i class="bi bi-pencil"></i>';
            editButton.title = "Editar Pedido";
            editButton.onclick = (e) => { e.stopPropagation(); openPedidoModal(pedido.id); };
            cardHeader.appendChild(editButton);
            cardDiv.appendChild(cardHeader);

            const cardBody = document.createElement('div');
            cardBody.classList.add('kanban-card-body');
            const etapasP = document.createElement('p');
            etapasP.classList.add('etapas-display');
            etapasP.innerHTML = `<strong>Secuencia:</strong> ${(pedido.etapasSecuencia || []).slice(0, -1).join(' <i class="bi bi-arrow-right-short"></i> ')}`;
            cardBody.appendChild(etapasP);
            cardDiv.appendChild(cardBody);

             if (pedido.etapaActual !== 'Completado') {
                const cardFooter = document.createElement('div');
                cardFooter.classList.add('kanban-card-footer');
                const completeButton = document.createElement('button');
                completeButton.classList.add('btn', 'btn-sm', 'btn-success');
                completeButton.innerHTML = '<i class="bi bi-check-lg"></i> Completar Etapa';
                completeButton.onclick = (e) => { e.stopPropagation(); completeStage(pedido.id); };
                cardFooter.appendChild(completeButton);
                cardDiv.appendChild(cardFooter);
             }
            return cardDiv;
        }

        function addDragAndDropListeners() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.kanban-column');
            cards.forEach(card => {
                card.addEventListener('dragstart', dragStart);
                card.addEventListener('dragend', dragEnd);
            });
            columns.forEach(column => {
                column.addEventListener('dragover', dragOver);
                column.addEventListener('dragenter', dragEnter);
                column.addEventListener('dragleave', dragLeave);
                column.addEventListener('drop', drop);
            });
        }

        function dragStart(e) {
            // Check if the event target is the card itself or a child that isn't interactive
            if (e.target.classList.contains('kanban-card')) {
                 draggedItemId = e.target.dataset.id;
                 setTimeout(() => e.target.classList.add('invisible'), 0);
                 console.log(`Drag Start: ${draggedItemId}`);
            } else {
                 // If drag started on an interactive element like a button, prevent drag
                 e.preventDefault();
                 console.log("Drag prevented on interactive element");
            }

        }
        function dragEnd(e) {
            // Ensure the element exists before removing class
            if(e.target && e.target.classList) {
                e.target.classList.remove('invisible');
            }
            draggedItemId = null;
            console.log("Drag End");
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }
        function dragOver(e) {
            e.preventDefault();
             if (e.target.classList.contains('kanban-column')) {
                e.target.classList.add('drag-over');
             }
        }
        function dragEnter(e) {
            e.preventDefault();
            if (e.target.classList.contains('kanban-column')) {
                 e.target.classList.add('drag-over');
                 console.log(`Drag Enter Column: ${e.target.dataset.etapa}`);
            }
        }
        function dragLeave(e) {
             // Check relatedTarget to prevent flickering when moving over child elements
             if (!e.currentTarget.contains(e.relatedTarget) && e.target.classList.contains('kanban-column')) {
                 e.target.classList.remove('drag-over');
                 console.log(`Drag Leave Column: ${e.target.dataset.etapa}`);
             }
        }
        async function drop(e) {
            e.preventDefault();
            e.stopPropagation();
            let targetColumn = e.target;
            while (targetColumn && !targetColumn.classList.contains('kanban-column')) {
                targetColumn = targetColumn.parentElement;
            }

            if (targetColumn && targetColumn.classList.contains('kanban-column') && draggedItemId) {
                const targetEtapa = targetColumn.dataset.etapa;
                console.log(`Drop on Column: ${targetEtapa}, Item ID: ${draggedItemId}`);
                targetColumn.classList.remove('drag-over');

                const pedido = currentPedidos.find(p => p.id === draggedItemId);

                if (pedido && pedido.etapaActual !== targetEtapa) {
                    const newIndex = pedido.etapasSecuencia.indexOf(targetEtapa);
                    if (newIndex !== -1) {
                        console.log(`Updating pedido ${draggedItemId} to etapa ${targetEtapa} (index ${newIndex})`);
                        const pedidoRef = doc(db, "pedidos", draggedItemId);
                        try {
                            await updateDoc(pedidoRef, {
                                etapaActual: targetEtapa,
                                indiceEtapaActual: newIndex,
                                updatedAt: serverTimestamp()
                            });
                            console.log("Pedido actualizado por Drag & Drop.");
                        } catch (error) {
                            console.error("Error al actualizar pedido por Drag & Drop:", error);
                            alert("Error al mover el pedido.");
                            renderActiveView(currentPedidos);
                        }
                    } else {
                         console.warn(`La etapa ${targetEtapa} no está en la secuencia del pedido ${draggedItemId}. Movimiento inválido.`);
                         alert(`Movimiento inválido: La etapa "${targetEtapa}" no pertenece a la secuencia de este pedido.`);
                    }
                } else if (pedido && pedido.etapaActual === targetEtapa) {
                     console.log("Drop en la misma columna, no se requiere actualización.");
                }
            } else {
                 console.log("Drop inválido (fuera de columna o sin item arrastrado)");
                 document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            }
            draggedItemId = null;
        }

        // --- List View Rendering ---
        function renderList(pedidos) {
            const listView = document.getElementById('list-view');
            if (!listView) return;
            const columns = [ /* ... (column definitions no changes) ... */
                 { key: 'numeroPedido', label: 'Nº Pedido' },
                { key: 'cliente', label: 'Cliente' },
                { key: 'maquinaImpresion', label: 'Máq. Impresión' },
                { key: 'metros', label: 'Metros' },
                { key: 'superficie', label: 'SUP', format: (val) => val ? 'Sí' : 'No' },
                { key: 'transparencia', label: 'TTE', format: (val) => val ? 'Sí' : 'No' },
                { key: 'capa', label: 'Capa' },
                { key: 'camisa', label: 'Camisa' },
                { key: 'fecha', label: 'Fecha (FH)' },
                { key: 'etapaActual', label: 'Etapa Actual' },
                { key: 'etapasSecuencia', label: 'Secuencia Completa', format: (val) => (val || []).join(' -> ') },
                { key: 'observaciones', label: 'Observaciones' },
            ];
            let tableHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <thead class="table-light">
                            <tr>`;
            columns.forEach(col => tableHTML += `<th>${col.label}</th>`);
            tableHTML += `<th>Acciones</th></tr></thead><tbody>`;
            pedidos.forEach(pedido => {
                tableHTML += `<tr>`;
                columns.forEach(col => {
                    let value = pedido[col.key];
                    if (col.format) { value = col.format(value); }
                    tableHTML += `<td>${value !== null && value !== undefined ? value : 'N/A'}</td>`;
                });
                tableHTML += `
                        <td>
                            <button class="btn btn-sm btn-outline-primary" title="Editar Pedido" onclick="window.openPedidoModal('${pedido.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            </td>
                    </tr>
                `;
            });
            tableHTML += `</tbody></table></div>`;
            listView.innerHTML = tableHTML;
        }

        // --- Modal Logic ---
        function openPedidoModal(pedidoId = null) { /* ... (no changes) ... */ }
        window.openPedidoModal = openPedidoModal;
        async function savePedido(event) { /* ... (no changes) ... */ }

        // --- Complete Stage Logic ---
        async function completeStage(pedidoId) { /* ... (no changes) ... */ }

    </script>

</body>
</html>