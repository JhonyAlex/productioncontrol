<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Producción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        #app-container {
            display: none;
        }
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        #kanban-board {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 1rem;
        }
        .kanban-column {
            min-width: 300px;
            max-width: 350px;
            background-color: #e9ecef;
            border-radius: 0.5rem;
            padding: 0.5rem;
            flex-shrink: 0;
        }
        .kanban-column h5 {
            text-align: center;
            padding: 0.5rem;
            background-color: #dee2e6;
            border-radius: 0.3rem;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .kanban-card {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 0.3rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: grab;
        }
        .kanban-card h6 {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }
        .kanban-card p {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            color: #6c757d;
        }
        .modal-body .row > div {
             margin-bottom: 0.8rem;
        }
        #etapas-secuencia-container label {
            margin-right: 10px;
        }
    </style>
</head>
<body>

    <div id="login-container" class="login-container">
        <h2 class="text-center mb-4">Iniciar Sesión</h2>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Correo Electrónico</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div class="d-grid">
                <button type="submit" class="btn btn-primary">Ingresar</button>
            </div>
            <div id="login-error" class="text-danger mt-3 text-center" style="display: none;"></div>
        </form>
    </div>

    <div id="app-container" class="container-fluid mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Control Producción</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <span id="user-email" class="navbar-text me-3"></span>
                        </li>
                        <li class="nav-item">
                            <button id="logout-button" class="btn btn-outline-danger">Cerrar Sesión</button>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div id="main-content">
            <h1 class="text-center">Por favor, inicia sesión</h1>
        </div>
    </div>

    <div class="modal fade" id="pedidoModal" tabindex="-1" aria-labelledby="pedidoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pedidoModalLabel">Añadir Nuevo Pedido</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="pedido-form">
                        <input type="hidden" id="pedido-id">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="numeroPedido" class="form-label">Número Pedido (Cliente - Número)*</label>
                                <input type="text" class="form-control" id="numeroPedido" required>
                            </div>
                            <div class="col-md-6">
                                <label for="cliente" class="form-label">Cliente (Opcional)</label>
                                <input type="text" class="form-control" id="cliente">
                            </div>
                        </div>
                        <hr>
                        <h6>Características Principales</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="maquinaImpresion" class="form-label">Máquina Impresión*</label>
                                <select class="form-select" id="maquinaImpresion" required>
                                    <option value="" selected disabled>Seleccionar...</option>
                                    <option value="WindMöller 1">WindMöller 1</option>
                                    <option value="GIAVE">GIAVE</option>
                                    <option value="WindMöller 3">WindMöller 3</option>
                                    <option value="Anonimo">Anonimo</option>
                                </select>
                            </div>
                             <div class="col-md-4">
                                <label for="desarrTexto" class="form-label">Desarr. (Texto)</label>
                                <input type="text" class="form-control" id="desarrTexto">
                            </div>
                            <div class="col-md-4">
                                <label for="desarrNumero" class="form-label">Desarr. (Número)</label>
                                <input type="number" class="form-control" id="desarrNumero">
                            </div>
                            <div class="col-md-4">
                                <label for="metros" class="form-label">Metros</label>
                                <input type="number" class="form-control" id="metros">
                            </div>
                            <div class="col-md-4">
                                <label for="superficie" class="form-label">Superficie (SUP)</label>
                                <select class="form-select" id="superficie">
                                    <option value="false">No</option>
                                    <option value="true">Sí</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="transparencia" class="form-label">Transparencia (TTE)</label>
                                <select class="form-select" id="transparencia">
                                    <option value="false">No</option>
                                    <option value="true">Sí</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="capa" class="form-label">Capa (CAPA)</label>
                                <input type="text" class="form-control" id="capa">
                            </div>
                            <div class="col-md-4">
                                <label for="camisa" class="form-label">Camisa</label>
                                <input type="text" class="form-control" id="camisa">
                            </div>
                             <div class="col-md-4">
                                <label for="fecha" class="form-label">Fecha (FH)</label>
                                <input type="text" class="form-control" id="fecha" placeholder="DD/MM">
                            </div>
                        </div>
                         <div class="row">
                             <div class="col-12">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" rows="2"></textarea>
                            </div>
                        </div>
                        <hr>
                        <h6>Secuencia de Etapas (Seleccionar en orden)</h6>
                        <p class="form-text text-muted">La etapa de impresión seleccionada arriba se añadirá automáticamente al inicio.</p>
                        <div id="etapas-secuencia-container" class="mb-3">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Laminación SL2" id="etapa-sl2">
                                <label class="form-check-label" for="etapa-sl2">Laminación SL2</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Laminación NEXUS" id="etapa-nexus">
                                <label class="form-check-label" for="etapa-nexus">Laminación NEXUS</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Perforación MAC" id="etapa-mac">
                                <label class="form-check-label" for="etapa-mac">Perforación MAC</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Perforación MIC" id="etapa-mic">
                                <label class="form-check-label" for="etapa-mic">Perforación MIC</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Rebobinado S2DT" id="etapa-s2dt">
                                <label class="form-check-label" for="etapa-s2dt">Rebobinado S2DT</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Rebobinado PROSLIT" id="etapa-proslit">
                                <label class="form-check-label" for="etapa-proslit">Rebobinado PROSLIT</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Rebobinado TEMAC" id="etapa-temac">
                                <label class="form-check-label" for="etapa-temac">Rebobinado TEMAC</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Pendiente de Laminar" id="etapa-pdlam">
                                <label class="form-check-label" for="etapa-pdlam">P.D. Laminar</label>
                            </div>
                             <div class="form-check form-check-inline">
                                <input class="form-check-input etapa-check" type="checkbox" value="Pendiente de Rebobinado" id="etapa-pdreb">
                                <label class="form-check-label" for="etapa-pdreb">P.D. Rebobinado</label>
                            </div>
                            </div>
                        </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" form="pedido-form">Guardar Pedido</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script type="module">
        // Imports de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            onSnapshot,
            doc, // Importar doc
            updateDoc // Importar updateDoc
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Configuración Firebase
        const firebaseConfig = {
          apiKey: "AIzaSyBp5a0lUJYZWhtUTVDuwn1jvj6TodaCyrc",
          authDomain: "production-control-pigmea.firebaseapp.com",
          projectId: "production-control-pigmea",
          storageBucket: "production-control-pigmea.firebasestorage.app",
          messagingSenderId: "1008458265879",
          appId: "1:1008458265879:web:008889d56b1d4de3cc3352"
        };

        // Inicialización Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const pedidosCollection = collection(db, "pedidos");

        console.log("Firebase inicializado.");

        // --- Elementos DOM ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userEmailSpan = document.getElementById('user-email');
        const mainContent = document.getElementById('main-content');
        const pedidoModalElement = document.getElementById('pedidoModal');
        const pedidoModal = new bootstrap.Modal(pedidoModalElement);
        const pedidoForm = document.getElementById('pedido-form');
        const pedidoModalLabel = document.getElementById('pedidoModalLabel');
        const pedidoIdInput = document.getElementById('pedido-id');

        // --- Listeners de Autenticación (Movidos fuera de onAuthStateChanged) ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.style.display = 'none';

            try {
                console.log(`Intentando iniciar sesión con ${email}`);
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Inicio de sesión exitoso:", userCredential.user);
                // onAuthStateChanged maneja la UI
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                loginError.textContent = getFirebaseErrorMessage(error);
                loginError.style.display = 'block';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Cierre de sesión exitoso.");
                // onAuthStateChanged maneja la UI
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                alert("Error al cerrar sesión. Inténtalo de nuevo.");
            }
        });

        // --- Observador de Estado de Autenticación ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuario conectado:", user.email);
                loginContainer.style.display = 'none';
                appContainer.style.display = 'block';
                userEmailSpan.textContent = user.email;
                loadMainAppData(); // Cargar contenido principal
            } else {
                console.log("Usuario desconectado.");
                loginContainer.style.display = 'block';
                appContainer.style.display = 'none';
                userEmailSpan.textContent = '';
                mainContent.innerHTML = '<h1 class="text-center">Por favor, inicia sesión</h1>';
                // Detener listeners de Firestore si el usuario cierra sesión
                if (unsubscribePedidos) {
                    console.log("Deteniendo listener de pedidos.");
                    unsubscribePedidos();
                    unsubscribePedidos = null;
                }
            }
        });

        function getFirebaseErrorMessage(error) {
             switch (error.code) {
                case 'auth/invalid-email': return 'El formato del correo electrónico no es válido.';
                case 'auth/user-disabled': return 'Este usuario ha sido deshabilitado.';
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential': return 'Correo electrónico o contraseña incorrectos.';
                case 'auth/too-many-requests': return 'Demasiados intentos fallidos. Inténtalo más tarde.';
                default: return 'Error al iniciar sesión. Por favor, inténtalo de nuevo.';
            }
        }


        // --- Lógica Principal de la Aplicación ---
        let currentPedidos = [];
        let unsubscribePedidos = null;

        function loadMainAppData() {
            console.log("Cargando datos principales de la aplicación...");
            // Solo configurar listeners y cargar datos si no se ha hecho ya
             if (!document.getElementById('view-kanban-btn')) {
                mainContent.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button id="view-kanban-btn" class="btn btn-primary me-2 active">Vista Kanban</button>
                            <button id="view-list-btn" class="btn btn-secondary">Vista Lista</button>
                        </div>
                        <div>
                            <input type="text" id="search-input" class="form-control d-inline-block w-auto me-2" placeholder="Buscar pedido...">
                            <button id="add-pedido-btn" class="btn btn-success">+ Añadir Pedido</button>
                        </div>
                    </div>
                    <div id="kanban-board" class="mt-4"></div>
                    <div id="list-view" class="mt-4" style="display: none;"></div>
                `;

                // Añadir listeners botones de vista
                const viewKanbanBtn = document.getElementById('view-kanban-btn');
                const viewListBtn = document.getElementById('view-list-btn');
                const kanbanBoard = document.getElementById('kanban-board');
                const listView = document.getElementById('list-view');

                viewKanbanBtn.addEventListener('click', () => {
                    kanbanBoard.style.display = 'flex';
                    listView.style.display = 'none';
                    viewKanbanBtn.classList.add('active');
                    viewListBtn.classList.remove('active');
                    renderKanban(currentPedidos);
                });
                viewListBtn.addEventListener('click', () => {
                    kanbanBoard.style.display = 'none';
                    listView.style.display = 'block';
                    viewKanbanBtn.classList.remove('active');
                    viewListBtn.classList.add('active');
                    renderList(currentPedidos);
                });

                // Listener para abrir el modal
                document.getElementById('add-pedido-btn').addEventListener('click', () => openPedidoModal()); // Asegurar que llama sin argumento

                // Listener para el formulario del modal (solo se añade una vez)
                if (!pedidoForm.dataset.listenerAttached) {
                     pedidoForm.addEventListener('submit', savePedido);
                     pedidoForm.dataset.listenerAttached = 'true'; // Marcar que el listener fue añadido
                }


                // Listener para búsqueda
                document.getElementById('search-input').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredPedidos = currentPedidos.filter(pedido =>
                        pedido.numeroPedido.toLowerCase().includes(searchTerm) ||
                        (pedido.cliente && pedido.cliente.toLowerCase().includes(searchTerm))
                    );
                    if (kanbanBoard.style.display !== 'none') {
                        renderKanban(filteredPedidos);
                    } else {
                        renderList(filteredPedidos);
                    }
                });
            }

            // Empezar a escuchar cambios en los pedidos (o reanudar si ya existía)
            if (!unsubscribePedidos) {
                 listenToPedidos();
            } else {
                 // Si el listener ya existe, forzar un re-renderizado inicial
                 if (document.getElementById('kanban-board') && document.getElementById('kanban-board').style.display !== 'none') {
                    renderKanban(currentPedidos);
                 } else if (document.getElementById('list-view')) {
                    renderList(currentPedidos);
                 }
            }
        }

        function listenToPedidos() {
            console.log("Escuchando cambios en la colección 'pedidos'...");
            if (unsubscribePedidos) unsubscribePedidos(); // Detener listener anterior si existe

            const q = query(pedidosCollection);

            unsubscribePedidos = onSnapshot(q, (querySnapshot) => {
                currentPedidos = [];
                querySnapshot.forEach((doc) => {
                    currentPedidos.push({ id: doc.id, ...doc.data() });
                });
                console.log("Pedidos actualizados:", currentPedidos);
                // Renderizar la vista activa
                 const kanbanBoard = document.getElementById('kanban-board');
                 if (kanbanBoard && kanbanBoard.style.display !== 'none') {
                    renderKanban(currentPedidos);
                 } else if (document.getElementById('list-view')) {
                    renderList(currentPedidos);
                 }
            }, (error) => {
                console.error("Error al escuchar pedidos:", error);
                alert("Error al cargar los datos. Por favor, recarga la página.");
                if (unsubscribePedidos) unsubscribePedidos(); // Detener en caso de error
                unsubscribePedidos = null;
            });
        }

        // --- Renderizado de Vistas ---
        function renderKanban(pedidos) {
            const kanbanBoard = document.getElementById('kanban-board');
            if (!kanbanBoard) return;

            const etapas = [ /* ... (lista de etapas sin cambios) ... */
                 "Impresión WindMöller 1", "Impresión GIAVE", "Impresión WindMöller 3", "Impresión Anonimo",
                "Laminación SL2", "Laminación NEXUS",
                "Perforación MAC", "Perforación MIC",
                "Rebobinado S2DT", "Rebobinado PROSLIT", "Rebobinado TEMAC",
                "Pendiente de Laminar", "Pendiente de Rebobinado",
                "Completado"
            ];
            kanbanBoard.innerHTML = '';

            etapas.forEach(etapa => {
                const columnDiv = document.createElement('div');
                columnDiv.classList.add('kanban-column');
                columnDiv.dataset.etapa = etapa;
                const title = document.createElement('h5');
                title.textContent = etapa;
                columnDiv.appendChild(title);

                const pedidosEnEtapa = pedidos.filter(p => p.etapaActual === etapa);
                pedidosEnEtapa.forEach(pedido => {
                    const cardDiv = document.createElement('div');
                    cardDiv.classList.add('kanban-card');
                    cardDiv.draggable = true;
                    cardDiv.dataset.id = pedido.id;

                    const cardTitle = document.createElement('h6');
                    cardTitle.textContent = pedido.numeroPedido;
                    cardDiv.appendChild(cardTitle);

                    const detail1 = document.createElement('p');
                    detail1.textContent = `Máquina: ${pedido.maquinaImpresion || 'N/A'}`;
                    cardDiv.appendChild(detail1);
                    const detail2 = document.createElement('p');
                    detail2.textContent = `Metros: ${pedido.metros || 'N/A'}`;
                    cardDiv.appendChild(detail2);

                    const editButton = document.createElement('button');
                    editButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'float-end');
                    editButton.innerHTML = '<i class="bi bi-pencil"></i>';
                    editButton.onclick = (e) => {
                        e.stopPropagation(); // Evitar que el drag se active al hacer clic en el botón
                        openPedidoModal(pedido.id);
                    };
                    cardDiv.appendChild(editButton);

                    columnDiv.appendChild(cardDiv);
                });
                kanbanBoard.appendChild(columnDiv);
            });
            // TODO: Añadir lógica Drag and Drop
        }

        function renderList(pedidos) {
            const listView = document.getElementById('list-view');
             if (!listView) return;
             let tableHTML = `...`; // (Tabla HTML sin cambios)

            pedidos.forEach(pedido => {
                 tableHTML += `
                    <tr>
                        <td>${pedido.numeroPedido || 'N/A'}</td>
                        <td>${pedido.maquinaImpresion || 'N/A'}</td>
                        <td>${pedido.metros || 'N/A'}</td>
                        <td><span class="badge bg-info text-dark">${pedido.etapaActual || 'N/A'}</span></td>
                        <td>${(pedido.etapasSecuencia || []).join(' -> ')}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.openPedidoModal('${pedido.id}')">
                                <i class="bi bi-pencil"></i> Editar
                            </button>
                        </td>
                    </tr>
                `;
            });
            tableHTML += `</tbody></table></div>`;
            listView.innerHTML = tableHTML;
        }

        // --- Lógica del Modal ---
        function openPedidoModal(pedidoId = null) {
            pedidoForm.reset();
            pedidoIdInput.value = '';

            if (pedidoId) {
                // Modo Edición
                pedidoModalLabel.textContent = 'Editar Pedido';
                const pedido = currentPedidos.find(p => p.id === pedidoId);
                if (pedido) {
                    pedidoIdInput.value = pedido.id;
                    // Rellenar campos... (sin cambios)
                    document.getElementById('numeroPedido').value = pedido.numeroPedido || '';
                    document.getElementById('cliente').value = pedido.cliente || '';
                    document.getElementById('maquinaImpresion').value = pedido.maquinaImpresion || '';
                    document.getElementById('desarrTexto').value = pedido.desarrTexto || '';
                    document.getElementById('desarrNumero').value = pedido.desarrNumero || '';
                    document.getElementById('metros').value = pedido.metros || '';
                    document.getElementById('superficie').value = pedido.superficie ? 'true' : 'false';
                    document.getElementById('transparencia').value = pedido.transparencia ? 'true' : 'false';
                    document.getElementById('capa').value = pedido.capa || '';
                    document.getElementById('camisa').value = pedido.camisa || '';
                    document.getElementById('fecha').value = pedido.fecha || '';
                    document.getElementById('observaciones').value = pedido.observaciones || '';

                    const etapaChecks = document.querySelectorAll('.etapa-check');
                    etapaChecks.forEach(check => {
                        check.checked = (pedido.etapasSecuencia || []).includes(check.value);
                    });
                } else {
                    console.error("No se encontró el pedido con ID:", pedidoId);
                    alert("Error: No se pudo cargar el pedido para editar.");
                    return;
                }
            } else {
                // Modo Añadir Nuevo
                pedidoModalLabel.textContent = 'Añadir Nuevo Pedido';
                document.getElementById('superficie').value = 'false';
                document.getElementById('transparencia').value = 'false';
            }
            pedidoModal.show();
        }
        window.openPedidoModal = openPedidoModal; // Exponer globalmente

        async function savePedido(event) {
            event.preventDefault();
            console.log("Intentando guardar pedido...");
            const id = pedidoIdInput.value;
            const maquinaImpresionSeleccionada = document.getElementById('maquinaImpresion').value;

            const etapasSeleccionadas = [];
            if (maquinaImpresionSeleccionada) {
                etapasSeleccionadas.push(`Impresión ${maquinaImpresionSeleccionada}`);
            } else {
                 alert("Por favor, selecciona una máquina de impresión.");
                 return;
            }
            document.querySelectorAll('.etapa-check:checked').forEach(check => {
                etapasSeleccionadas.push(check.value);
            });
            etapasSeleccionadas.push('Completado');

            const pedidoData = {
                numeroPedido: document.getElementById('numeroPedido').value,
                cliente: document.getElementById('cliente').value || null,
                maquinaImpresion: maquinaImpresionSeleccionada,
                desarrTexto: document.getElementById('desarrTexto').value || null,
                desarrNumero: parseInt(document.getElementById('desarrNumero').value) || null,
                metros: parseInt(document.getElementById('metros').value) || null,
                superficie: document.getElementById('superficie').value === 'true',
                transparencia: document.getElementById('transparencia').value === 'true',
                capa: document.getElementById('capa').value || null,
                camisa: document.getElementById('camisa').value || null,
                fecha: document.getElementById('fecha').value || null,
                observaciones: document.getElementById('observaciones').value || null,
                etapasSecuencia: etapasSeleccionadas,
                // Si es edición, NO cambiar etapa actual ni índice aquí
                // Si es nuevo, sí establecerlos
                updatedAt: serverTimestamp()
            };

            // Solo establecer etapa inicial si es un nuevo pedido
            if (!id) {
                 pedidoData.etapaActual = etapasSeleccionadas.length > 0 ? etapasSeleccionadas[0] : 'Completado';
                 pedidoData.indiceEtapaActual = 0;
                 pedidoData.createdAt = serverTimestamp();
            } else {
                 // Para edición, necesitamos obtener la etapa actual y el índice del pedido existente
                 // Esto se hará cuando implementemos la actualización completa
            }


            try {
                if (id) {
                    // --- Implementación básica de Edición ---
                    console.log("Actualizando pedido con ID:", id);
                    // Referencia al documento existente
                    const pedidoRef = doc(db, "pedidos", id);
                    // Actualizar el documento. No se modifica createdAt, etapaActual ni indiceEtapaActual aquí.
                    // La etapa se cambiará con Drag&Drop o una acción específica.
                    await updateDoc(pedidoRef, pedidoData);
                    console.log("Pedido actualizado.");
                    // --- Fin Implementación Edición ---
                } else {
                    // Modo Añadir Nuevo
                    console.log("Añadiendo nuevo pedido:", pedidoData);
                    const docRef = await addDoc(pedidosCollection, pedidoData);
                    console.log("Pedido añadido con ID: ", docRef.id);
                }
                pedidoModal.hide();
                pedidoForm.reset();
            } catch (error) {
                console.error("Error al guardar pedido: ", error);
                alert(`Error al guardar el pedido: ${error.message}`);
            }
        }

    </script>

</body>
</html>